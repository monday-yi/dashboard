<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ‹ Monday Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111827;color:#e5e7eb;padding:12px;max-width:900px;margin:0 auto}
h1{font-size:18px;color:#60a5fa;margin-bottom:10px;display:flex;align-items:center;gap:8px}
h1 .refresh{font-size:12px;color:#6b7280;cursor:pointer;padding:2px 8px;border:1px solid #374151;border-radius:4px}
h1 .refresh:hover{color:#e5e7eb;border-color:#60a5fa}
.alert-box{margin-bottom:10px}
.alert{background:#7f1d1d;border:1px solid #f87171;border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:12px;color:#fca5a5}
.alert strong{color:#f87171}
.no-alert{background:#064e3b;border:1px solid #34d399;border-radius:6px;padding:8px 12px;font-size:12px;color:#6ee7b7}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.grid{grid-template-columns:1fr}}
.card{background:#1f2937;border-radius:8px;padding:12px;border:1px solid #374151}
.card h2{font-size:12px;color:#9ca3af;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.bar-wrap{margin:5px 0}
.bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px}
.bar-label .name{color:#d1d5db;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}
.bar-label .pct{font-weight:600}
.bar-bg{height:7px;background:#374151;border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width .3s}
.green{background:#34d399}.yellow{background:#fbbf24}.red{background:#f87171}
.cron-table{width:100%;font-size:11px;border-collapse:collapse}
.cron-table th{text-align:left;color:#6b7280;padding:3px 4px;border-bottom:1px solid #374151}
.cron-table td{padding:3px 4px;border-bottom:1px solid #1f2937}
.status-ok{color:#34d399}.status-warn{color:#fbbf24}.status-err{color:#f87171}
.cron-note{color:#6b7280;font-style:italic;max-width:220px}
.queue-item{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #374151;font-size:12px}
.queue-item:last-child{border:none}
.owner{color:white;padding:1px 5px;border-radius:3px;font-size:10px}
.owner-monday{background:#3b82f6}.owner-coder{background:#f59e0b}.owner-echo{background:#8b5cf6}
.deadline{color:#9ca3af;white-space:nowrap}
.stat-row{display:flex;justify-content:space-between;padding:3px 0;font-size:12px;border-bottom:1px solid #374151}
.stat-row:last-child{border:none}
.stat-val{font-weight:600;color:#60a5fa}
.full-width{grid-column:1/-1}
.ts{font-size:11px;color:#6b7280;text-align:right;margin-top:8px}
.empty{color:#6b7280;font-size:12px;padding:8px 0}
.phase-done{color:#34d399}.phase-wip{color:#fbbf24}.phase-queue{color:#6b7280}
</style>
</head>
<body>

<h1>ğŸ‹ Monday Dashboard <span class="refresh" onclick="loadData()">â†» åˆ·æ–°</span></h1>
<div id="alerts" class="alert-box"></div>
<div class="grid" id="grid"></div>
<div class="ts" id="ts"></div>

<script>
const DATA_URL = 'data.json';

function pctColor(p) { return p >= 70 ? 'red' : p >= 50 ? 'yellow' : 'green'; }
function pctHex(p) { return p >= 70 ? '#f87171' : p >= 50 ? '#fbbf24' : '#34d399'; }
function statusIcon(s) {
  if (s === 'ok') return '<span class="status-ok">âœ…</span>';
  if (s === 'pending') return '<span class="status-warn">â³</span>';
  return '<span class="status-err">âŒ</span>';
}
function ownerClass(o) {
  const k = o.toLowerCase();
  if (k.includes('monday') || k.includes('mon')) return 'owner-monday';
  if (k.includes('coder') || k.includes('cod')) return 'owner-coder';
  if (k.includes('echo')) return 'owner-echo';
  return 'owner-monday';
}
function phaseLabel(s) {
  if (s === 'done') return '<span class="phase-done">âœ… å®Œæˆ</span>';
  if (s === 'in_progress') return '<span class="phase-wip">â³ è¿›è¡Œä¸­</span>';
  return '<span class="phase-queue">æ’é˜Ÿä¸­</span>';
}

function render(d) {
  // Alerts
  const ab = document.getElementById('alerts');
  if (d.alerts && d.alerts.length > 0) {
    ab.innerHTML = d.alerts.map(a => `<div class="alert"><strong>âš ï¸</strong> ${a}</div>`).join('');
  } else {
    ab.innerHTML = '<div class="no-alert">âœ… ä¸€åˆ‡æ­£å¸¸ï¼Œæ— å‘Šè­¦</div>';
  }

  let html = '';

  // Context bars
  html += '<div class="card"><h2>ğŸ“Š ä¸Šä¸‹æ–‡å æ¯”</h2>';
  if (d.contexts && d.contexts.length > 0) {
    d.contexts.forEach(c => {
      html += `<div class="bar-wrap">
        <div class="bar-label"><span class="name">${c.name}</span><span class="pct" style="color:${pctHex(c.pct)}">${c.pct}%</span></div>
        <div class="bar-bg"><div class="bar-fill ${pctColor(c.pct)}" style="width:${Math.min(c.pct,100)}%"></div></div>
      </div>`;
    });
  } else {
    html += '<div class="empty">æš‚æ— æ•°æ®</div>';
  }
  html += '</div>';

  // Queue (moved before system)
  html += '<div class="card"><h2>ğŸ“‹ æ‰¿è¯ºé˜Ÿåˆ—</h2>';
  if (d.queue && d.queue.length > 0) {
    d.queue.forEach(q => {
      html += `<div class="queue-item">
        <div><span class="owner ${ownerClass(q.owner)}">${q.owner}</span> ${q.desc}</div>
        <div class="deadline">â³ ${q.deadline || 'æ— '}</div>
      </div>`;
    });
  } else {
    html += '<div class="empty">é˜Ÿåˆ—æ¸…ç©º ğŸ‰</div>';
  }
  html += '</div>';

  // In-progress tasks
  html += '<div class="card"><h2>ğŸ§© è¿›è¡Œä¸­ä»»åŠ¡</h2>';
  if (d.tasks && d.tasks.length > 0) {
    d.tasks.forEach(t => {
      html += `<div class="queue-item">
        <div><span class="owner ${ownerClass(t.owner || 'unknown')}">${t.owner || 'unknown'}</span> #${t.name || t.id}</div>
        <div class="deadline">${t.status || 'unknown'}</div>
      </div>`;
    });
  } else {
    html += '<div class="empty">æš‚æ— è¿›è¡Œä¸­ä»»åŠ¡</div>';
  }
  html += '</div>';

  // Cron - split by type field (fallback to status for compat)
  const recurCrons = (d.crons || []).filter(c => (c.type || '') === 'recurring' || (!c.type && c.status !== 'pending'));
  const onceCrons = (d.crons || []).filter(c => (c.type || '') === 'once' || (!c.type && c.status === 'pending'));

  html += '<div class="card full-width"><h2>â° å¾ªç¯ä»»åŠ¡</h2>';
  if (recurCrons.length > 0) {
    html += '<table class="cron-table"><tr><th>ä»»åŠ¡</th><th>çŠ¶æ€</th><th>é¢‘ç‡</th><th>è¯´æ˜</th></tr>';
    recurCrons.forEach(c => {
      html += `<tr><td>${c.name}</td><td>${statusIcon(c.status)}</td><td>${c.freq}</td><td class="cron-note">${c.note || ''}</td></tr>`;
    });
    html += '</table>';
  } else {
    html += '<div class="empty">æ— å¾ªç¯ä»»åŠ¡</div>';
  }
  html += '</div>';

  html += '<div class="card full-width"><h2>ğŸ“Œ ä¸€æ¬¡æ€§ä»»åŠ¡</h2>';
  if (onceCrons.length > 0) {
    html += '<table class="cron-table"><tr><th>ä»»åŠ¡</th><th>çŠ¶æ€</th><th>è§¦å‘æ—¶é—´</th><th>è¯´æ˜</th></tr>';
    onceCrons.forEach(c => {
      html += `<tr><td>${c.name}</td><td>${statusIcon(c.status)}</td><td>${c.freq}</td><td class="cron-note">${c.note || ''}</td></tr>`;
    });
    html += '</table>';
  } else {
    html += '<div class="empty">æ— ä¸€æ¬¡æ€§ä»»åŠ¡</div>';
  }
  html += '</div>';

  // System
  if (d.system) {
    const s = d.system;
    html += `<div class="card"><h2>ğŸ¥ ç³»ç»ŸçŠ¶æ€</h2>
      <div class="stat-row"><span>æ´»è·ƒä¼šè¯</span><span class="stat-val">${s.sessions}</span></div>
      <div class="stat-row"><span>Agent</span><span class="stat-val">${s.agents}</span></div>
      <div class="stat-row"><span>é€šé“</span><span class="stat-val">${s.channels}</span></div>
      <div class="stat-row"><span>Cron è¿ç»­å¤±è´¥</span><span class="stat-val" style="color:${s.cronFails > 0 ? '#f87171' : '#34d399'}">${s.cronFails}</span></div>
      <div class="stat-row"><span>æœ€è¿‘å¤‡ä»½</span><span class="stat-val">${s.lastBackup}</span></div>
    </div>`;

    if (s.sessionsSend) {
      const ss = s.sessionsSend;
      const healthColor = ss.health === 'ok' ? '#34d399' : (ss.health === 'idle' ? '#9ca3af' : '#f87171');
      html += `<div class="card"><h2>ğŸ“¨ Sessions Send å¥åº·</h2>
        <div class="stat-row"><span>å¥åº·çŠ¶æ€</span><span class="stat-val" style="color:${healthColor}">${ss.health}</span></div>
        <div class="stat-row"><span>ç»Ÿè®¡çª—å£</span><span class="stat-val">${ss.windowHours}h</span></div>
        <div class="stat-row"><span>æˆåŠŸç‡</span><span class="stat-val">${ss.successRate}%</span></div>
        <div class="stat-row"><span>ä¸¢å¼ƒç‡</span><span class="stat-val">${ss.dropRate}%</span></div>
        <div class="stat-row"><span>é˜Ÿåˆ—ç§¯å‹</span><span class="stat-val" style="color:${ss.queuePending > 0 ? '#f87171' : '#34d399'}">${ss.queuePending}</span></div>
        <div class="stat-row"><span>æ€»é‡/æˆåŠŸ/ä¸¢å¼ƒ</span><span class="stat-val">${ss.total}/${ss.ok}/${ss.drop}</span></div>
        <div class="stat-row"><span>æœ€è¿‘å‘Šè­¦</span><span class="stat-val" style="font-size:10px;max-width:55%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ss.lastAlert || 'æ— '}</span></div>
        <div class="stat-row"><span>æœ€è¿‘é‡æ”¾</span><span class="stat-val" style="font-size:10px;max-width:55%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ss.lastReplay || 'æ— '}</span></div>
      </div>`;
    }
  }

  // Upgrade
  if (d.upgrade) {
    const u = d.upgrade;
    html += `<div class="card"><h2>ğŸš€ ç»Ÿä¸€å‡çº§è¿›åº¦</h2>
      <div class="stat-row"><span>Phase 0 åŸºç¡€ä¿éšœ</span>${phaseLabel(u.phase0)}</div>
      <div class="stat-row"><span>Phase 1 å¯é æ€§</span>${phaseLabel(u.phase1)}</div>
      <div class="stat-row"><span>Phase 2 è´¨é‡</span>${phaseLabel(u.phase2)}</div>
      <div class="stat-row"><span>Phase 3 è‡ªè¿›åŒ–</span>${phaseLabel(u.phase3)}</div>
      ${u.deferred ? `<div class="stat-row"><span>æš‚ç¼“</span><span style="color:#4b5563">${u.deferred}</span></div>` : ''}
    </div>`;
  }

  document.getElementById('grid').innerHTML = html;

  // Timestamp
  if (d.updated) {
    const t = new Date(d.updated);
    document.getElementById('ts').textContent = `æ•°æ®æ›´æ–°ï¼š${t.toLocaleString('zh-CN', {timeZone:'Asia/Shanghai'})} CST`;
  }
}

function loadData() {
  fetch(DATA_URL + '?t=' + Date.now())
    .then(r => r.json())
    .then(render)
    .catch(e => {
      document.getElementById('alerts').innerHTML = `<div class="alert"><strong>âš ï¸</strong> åŠ è½½æ•°æ®å¤±è´¥ï¼š${e.message}</div>`;
    });
}

loadData();
</script>
</body>
</html>
